# =============================================================
# SecretProviderClass — Key Vault のシークレットを K8s Secret に同期
#
# このファイルは setup-keyvault.sh が自動生成・適用します。
# 手動で適用する場合は以下の値を置き換えてください:
#   <IDENTITY_CLIENT_ID>  → Managed Identity のクライアント ID
#   <KEY_VAULT_NAME>      → Key Vault 名
#   <TENANT_ID>           → Azure テナント ID
# =============================================================
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: appinsights-keyvault
  namespace: default
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    clientID: "<IDENTITY_CLIENT_ID>"
    keyvaultName: "<KEY_VAULT_NAME>"
    tenantId: "<TENANT_ID>"
    objects: |
      array:
        - |
          objectName: appinsights-connection-string
          objectType: secret
          objectVersion: ""
  # Key Vault のシークレットを K8s Secret に同期
  # → otel-collector は secretKeyRef で参照（コード変更不要）
  secretObjects:
  - secretName: appinsights-secret
    type: Opaque
    data:
    - objectName: appinsights-connection-string
      key: connection-string
